<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Pages アイトラッキング Demo</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#000; color:#fff; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    #info { text-align:center; padding:20px; max-width:90%; }
    #container { position:relative; width:100%; max-width:800px; aspect-ratio:16/9; background:#111; overflow:hidden; }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0.3; }
    #gaze { position:absolute; width:32px; height:32px; background:radial-gradient(circle, #ff0 30%, transparent 70%); border-radius:50%; transform:translate(-50%,-50%); pointer-events:none; box-shadow:0 0 20px #ff0; opacity:0; transition:opacity 0.3s; z-index:10; }
    button { padding:14px 40px; font-size:1.3em; margin:15px; background:#c00; color:white; border:none; border-radius:8px; cursor:pointer; }
    button:hover { background:#f00; }
    #msg { margin-top:10px; font-size:1.1em; color:#ffcc00; }
  </style>
</head>
<body>
  <div id="info">
    <h2>ウェブカメラ アイトラッキング（GitHub Pages版）</h2>
    <p>カメラ許可を「許可」してください。<br>次に画面上の点をクリックしてキャリブレーション（9〜20点推奨）</p>
    <button id="start">カメラON & 開始</button>
    <div id="msg"></div>
  </div>

  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <div id="gaze"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/brownhci/WebGazer@master/dist/webgazer.js"></script>
  <script>
    const gaze = document.getElementById('gaze');
    const msg = document.getElementById('msg');
    const startBtn = document.getElementById('start');

    startBtn.onclick = async () => {
      msg.textContent = 'カメラ起動中... ポップアップで「許可」を押して';
      try {
        await webgazer
          .setGazeListener((data) => {
            if (!data) {
              gaze.style.opacity = '0';
              return;
            }
            gaze.style.left = data.x + 'px';
            gaze.style.top = data.y + 'px';
            gaze.style.opacity = '0.9';
          })
          .showVideoPreview(true)      // 自分の顔映像を表示（位置調整に便利）
          .showPredictionPoints(true)  // 予測点（赤点）表示でデバッグ
          .applyKalmanFilter(true)     // 揺れ軽減
          .begin();

        msg.textContent = '成功！ 赤い点をクリックしてキャリブレーションしてください';
        startBtn.style.display = 'none';
      } catch (err) {
        console.error(err);
        let errText = 'エラー: ' + err.name + ' – ' + err.message;
        if (err.name === 'NotAllowedError') {
          errText += '\nカメラ許可が出ない → アドレスバーの鍵アイコン → カメラ → 「許可」に変更';
        } else if (err.message.includes('secure')) {
          errText += '\nhttpsで開いてるはずですが... URL確認を（github.ioのはず）';
        }
        msg.textContent = errText;
        msg.style.color = '#ff6666';
      }
    };
  </script>
</body>
</html>
